# 虚拟化

云计算1.0时代以虚拟化为主，并在此基础上进一步发展，因此虚拟化也成为云计算的入门技术，本章重点介绍计算虚拟化的架构及相关技术。虚拟化一定是软件实现的技术，是通过软件将物理资源转变为虚拟化资源（也叫逻辑资源）。虚拟化技术本身存在多种分类，对不同类型的虚拟化技术进行粗浅的分析可以的出一个概论，虚拟化具备其专有能力，*通过软件将一个物理设备变为多个虚拟设备*，虽然可以虚拟出多个设备，但实际性能还是受到物理设备性能的限制。*只有将一个物理设备的资源通过切片发布给多个用户使用才能够实现资源的复用*，提高物理设备的利用率，同时多个虚拟资源之间的生命周期相互独立

大分小，即将一个设备变为多个设备，是虚拟化的一种形态。同时虚拟化还具备另一种形态，小聚大，即通过软件技术将多个设备聚合成一个强大的逻辑设备

## 计算虚拟化

一个服务器按纵向结构可以大致分为三个平面：硬件、OS、Application。OS与硬件紧密耦合并通过Driver驱动不同的硬件资源，Application与OS耦合并通过OS提供的API接口执行系统调用，用以驱动硬件资源，用户最终是在OS上安装并使用Application。在本小节中主要探讨计算资源的虚拟化，硬件组件中CPU、内存、I/O属于计算资源

### x86 CPU的保护环

![X86_CPU的保护环](file:///${DB}/image/RH318/X86_CPU%E7%9A%84%E4%BF%9D%E6%8A%A4%E7%8E%AF.png)

- Ring0：内核空间，特权级别，是OS/Driver的工作空间，直接驱动硬件 - 特权指令
- Ring3：用户空间，非特权级别，是App的工作空间，用户向App发起请求，App调用OS的API接口 - 用户指令

所谓的纵向结构分层实际上就是x86 CPU的保护环机制，也就是计算机特权级别。保护环的分层存在诸多优势

1、分层则意味着不同环对应着不同的职能，开发者可以仅针对具体的环开发相应层级的软件，改变一个环的软件不会影响到其他环

2、不同环对硬件的操作权限级别存在差异，越靠近硬件的环就越接近硬件的原始状态，所需的指令愈加具体和复杂，普通用户没有能力完成如此困难的操作，一旦对硬件的操作出现失误，可能会直接造成系统的崩溃，因此用户态无法直接操作硬件，而是需要通过内核来完成对硬件资源的安全的调用

综上，切忌不可通过App直接调用硬件，App也无法直接调用硬件，如果App通过相应的指令直接去调用硬件，也就是在用户态使用了特权指令，OS会产生Trap将此指令拦截并捕捉，认为此操作是异常








X86操作系统设计之初是直接在硬件上运行，它认为自己会占用计算机的所有硬件，X86提供了4个特权运行级别提供给操作系统和应用程序访问，运行级别也被称为Ring环，环是指CPU的运行级别。从`Ring 0~Ring 3`权限级别逐渐递减，就X86而言，操作系统或内核需要访问硬件、内存，因此它的代码要运行在最高级别`Ring 0`上，这样它就可以使用特权指令，包括中断、修改页表、访问设备等；应用程序的代码运行在最低级别`Ring 3`上，它不能直接做受限制的操作，如果应用程序需要执行受限制的操作时，例如访问硬盘读写文件，就需要执行系统调用或系统函数，执行系统调用时CPU的运行级别就会从`Ring 3`切换到`Ring 0`，并且跳转到系统调用的相应的代码中，由内核来完成硬件设备的访问，完成访问之后再由`Ring 0`返回给`Ring 3`，这个过程称之为用户态和内核态的切换

用户态与内核态之间的切换动作解决了X86 CPU在分别处理应用软件和操作系统的高级别应用操作的问题，到虚拟化技术的时候面临一个难点，Guest OS和Host OS都要抢占`Ring 0`运行级别，在这种场景下，产生了3种方案用于解决Gust OS和Host OS分别抢占`Ring 0`的问题

1. 全虚拟化
2. 半虚拟化
3. 硬件辅助虚拟化






**计算机特权级别**

- Ring0：内核空间，特权级别，直接驱动硬件 - 特权指令
- Ring3：用户空间，非特权级别，用户向App发起请求，App调用OS的API接口 - 用户指令

```diff
- 如果在用户空间出现了特权指令，OS会将此指令拦截并捕捉，认为此操作是异常
```

```
             传统HostOS                                              虚拟化OS

|----------------------------------|          |---------------------------------------------------|

|                                  |          |   |-------------|   |-------------|               | 

|                                  |          |   |    App      |   |    App      |     Ring3     |

|     App     Ring3   用户空间      |          |   |     OS      |   |     OS      |    用户空间     |

|                                  |          |   |     硬件     |   |    硬件     |               |

|                                  |          |   |-------------|   |-------------|               |   

|----------------------------------|          |---------------------------------------------------|

|      HostOS  Ring0  内核空间      |          |                      虚拟化OS                       |

|----------------------------------|          |---------------------------------------------------|

|                硬件               |          |                        硬件                        |

|----------------------------------|          |---------------------------------------------------|
```

在传统HostOS架构中，应用（app）与OS紧密耦合，OS与硬件紧密耦合，所有与外网通信的**指令流/数据流**都由App拷贝到OS，然后由OS拷贝到硬件（硬盘）中，最后将硬盘中的数据输出到网络。此时如果能在数据传输的路径上忽略OS层，转而将数据直接从App层拷贝至硬盘（buffer），这样在HostOS架构中能够缩短数据I/O路径，有效降低时延提高吞吐量，此为**直通技术**

在虚拟化OS架构中，传统OS层被*虚拟化OS*取代，*虚拟化OS*直接与硬件耦合，并将物理硬件资源转化为虚拟化资源，为应用层的VM提供虚拟化的硬件资源，VM中的OS与*传统OS架构*中的宿主机OS相同，但在VM中被称为GuestOS，GuestOS不知道自身处于用户空间，也不知道自身使用的硬件是虚拟化资源，所以GuestOS会像*宿主机OS*一样使用自身的硬件，向自身的硬件发送**特权指令**，而VM的硬件收到特权指令时必然会被*虚拟化OS*捕捉

```diff
- 虚拟化技术就是先将HostOS与硬件解耦，这样HostOS和其上运行的应用可以看作一个整体，然后在硬件上在添加一个虚拟化OS层，将多个HostOS放置在一个虚拟化OS上运行，虚拟化OS为上层的HostOS提供虚拟化资源，这样HostOS在不知情的情况下调用虚拟化硬件来达到物理资源的复用
```

> **补充**

1. 物理设备的内存是划分**区域**的，App与OS都有自己专用的区域
2. 在数据传输的路径上忽略OS层并不是真正的完全忽略OS层，只是在指令调度的时候减少从App层到OS层的拷贝数据的机会
3. 虚拟化OS也被称为hypervisor或VMM（Virtual Machine Monitor），常见的虚拟化OS有ESXi，XEN等

#### 虚拟化的特点

1. **分区**：为了能够在一台物理设备上运行多个VM，必须通过软件（VMM）的方式，将硬件资源切分，然后为每一个VM提供一套虚拟化的硬件资源
2. **隔离**：不同的VM之间互不影响，各自的生命周期也不相同，每个VM只与VMM层发生调用关系
3. **封装**：由于虚拟化OS的出现，GuestOS与硬件解耦，所以每一个VM关机后，它就是VMM上的一个文件，而虚拟化OS又最大化的解决了不同硬件之间的兼容问题，所以在VMM层上的VM，能够非常便捷的在不同的硬件平台之间进行**迁移**
4. **独立**：作为一个文件来看，每一个VM都是独立存在的，可以在多个主机之间迁移

**虚拟化程度**

1. **完全虚拟化** | 性能低 | GuestOS对硬件**完全无感知**
2. **半虚拟化** | 性能中 | 部分知道自身处于虚拟化环境
3. **硬件辅助虚拟化** | 性能高 | 知道自身处于虚拟化环境

**资源种类**

1. 计算资源 -> **计算虚拟化** -> CPU、内存、IO
2. 网络资源 -> **网络虚拟化**
3. 存储资源 -> **存储虚拟化**
